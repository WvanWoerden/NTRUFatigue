import numpy as np

@CachedFunction
def N(d, n, nonnegative=False, zeros=True):
    """
    Number of ways of writing ``n`` as a sum of ``d`` squares

    :param n: target value
    :param d: dimension of the vector
    :param nonegative: include nonnegative only
    :param zeros: allow zeros

    - when ``nonnegative == False and zeroes == True``, this is https://oeis.org/A122141

    - when ``nonnegative == True and zeroes == True``, this is https://oeis.org/A045852

    """
    cnts = 0
    if nonnegative:
        lbound = 0
    else:
        lbound = -int(ceil(sqrt(n)))

    ubound = int(ceil(sqrt(n)))

    for i in range(lbound, ubound+1):
        if not (i or zeros):
            continue

        if n-i**2 >= 0:
            if d > 1:
                cnts += N(d-1, n-i**2, nonnegative, zeros)
            elif n-i**2 == 0:
                cnts += 1
    return cnts

# sample 152 from ntru_phase,halfpeta.scilens.private,2021-05-20_15:07,b'2021-05-17'-b'main'-b'3173065'.log
n=151
d=2*n
DSD_lf = 292.2
DSD_kappa = 260
beta = 42
vsq=[64.00000000000001, 81.00000000000001, 9.0, 400.00000000000006, 156.21347222572746, 1782.6716712101527, 170.28940648474895, 1562.6492765269368, 543.3494232584127, 898.6659187927958, 69.81313129022045, 15.580893395584754, 431.8813370357337, 163.11241639025823, 521.3084785357405, 297.16588969700257, 71.03454140909412, 98.7885352742943, 95.03795367580979, 81.19624821441636, 76.14196686558631, 10.855519956597742, 284.8013999727473, 328.87126667395347, 23.604254515527497, 1.675069485010605, 27.978354697901768, 176.44246096324082, 258.84705122768105, 2209.759548139706, 1011.6553784283951, 19.63239869803835, 549.5663062084449, 49.374083749241784, 188.10868355648583, 184.63131686039105, 1.6650173514623539, 8.651972467008905, 665.1411368564098, 285.79134363629544, 933.3945371486858, 444.8848197978336, 8.562143339110925, 66.05089893011623, 953.8718216454441, 933.5574213792593, 465.2984993195831, 3.456592472357403, 943.5455801538711, 507.64607663085843, 578.9951458302363, 263.5939489545137, 29.138485246600773, 6.10284201166827, 14.876126947911523, 502.6162811316402, 7.288973980368584, 219.903589476662, 407.2507788633603, 815.6661088950409, 1068.5748478015755, 98.29765429980337, 169.14311948740206, 219.07123027030588, 2026.9563066619055, 1154.705171983018, 635.5639632683268, 604.5694491288775, 448.4627014228834, 58.609094036539126, 279.74258603798796, 498.05791402820756, 0.30168667971356466, 11.695728921576654, 7.180507108817377, 5.309093328685507, 702.2721135903441, 10.710771530989163, 73.48067661104986, 65.13242558278772, 2.297837737962781, 837.1961160754569, 125.88870587184311, 596.7397238770328, 61.87374118873773, 20.865093649818306, 309.95906818343394, 0.43589759543082546, 261.40690332302205, 146.78120642568825, 0.3661016738944432, 211.9337140514861, 8.302520011959121, 199.27410228549542, 312.3754375818052, 2023.5739203194566, 226.50008844576408, 294.2563476240549, 336.82438504708057, 55.729814872504924, 103.99581557196508, 791.474826449391, 264.783214525632, 77.38248467263695, 3324.266535405396, 54.30551219136683, 37.58240804105514, 552.6360338361329, 81.94597664825262, 400.9178268385102, 121.70247690277073, 497.9703346791463, 385.33186323560466, 62.54687546414284, 10.329232101033964, 86.50471037528472, 107.85277090645538, 7.167153245968429, 337.5801484052171, 825.2190150718354, 512.5853431035238, 46.36260723801059, 707.1283276965167, 217.86886171545203, 13.292601013751538, 51.58049967472582, 10.293939152797858, 695.115243307999, 87.16123524440141, 1304.6205630582988, 198.7362626262509, 382.12606048488584, 313.1241516516152, 85.93806706626278, 737.2532822548842, 511.281410292677, 30.956927662495133, 9.625957860233802, 146.31275644449488, 1.079309199369687, 140.48362487959665, 636.8055649338436, 662.2675349637631, 589.2364562401189, 193.4484994020272, 377.12050629817656, 0.01892171077563271, 42.36996506038743, 291.2525319986356, 464.606397663217, 242.62853271110282, 28.81669168241088, 84.51188169078209, 130.5356691397724, 117.39890294867016, 46.957391687397, 0.7168270654538862, 204.92956407926928, 210.20421078122095, 201.91232128965865, 102.00159062619993, 56.166729258613735, 30.393726373342425, 248.4378095727746, 72.14755573989892, 25.432040893106056, 4.511202217848742, 10.043055790539526, 53.08612247468155, 28.27543368818945, 18.209637567140636, 24.799902585025816, 105.20243009530984, 35.2069744536202, 60.118530208849904, 81.7065531217821, 131.69017241189582, 77.34265770074319, 0.32169691182547805, 61.93690377443044, 37.65214308523486, 0.28186038313465644, 81.90378814071742, 75.83943329300497, 74.12803540902432, 17.849813843858534, 5.597470681705433, 70.7937454957871, 3.31054664794886, 0.3947062067962001, 13.219904451067206, 5.222022273244683, 0.8496856406956969, 34.878027019615665, 39.5072321062823, 0.04047315280426969, 4.9966984513421675, 32.18987048060707, 17.84144848615871, 7.463821259411839, 7.191580228636006, 31.40025768116084, 4.847174343775858, 3.1501689931333896, 6.882624358329124, 8.24100814830236, 2.335552509563637, 19.380442750318334, 12.755258802805592, 0.38961217140181037, 1.1094747583227238, 0.1251163133450763, 15.350915312886118, 18.531790921254668, 0.4235510077875844, 1.3835014610972607, 0.29301558858379945, 2.091701577851526, 5.7310048182217415, 3.2049711610394933, 0.06589697706118874, 10.20144305205751, 2.1770844959847593, 0.0030314378329295098, 1.4237398313933713, 0.5157752076541007, 3.320071043075997, 0.10433748744861819, 0.18954631247367365, 3.2589744802087375, 2.100056221594124, 0.010057683573894352, 3.8647444343533013, 2.4028680176475166, 4.570215676693468, 0.41243571746304075, 5.652600991065906, 0.05842037916068736, 2.544221495580563, 0.001046957324757074, 0.024957949383636224, 3.7939939868343844, 0.7197060544885724, 0.16773510141416004, 2.387562578570814, 1.5320831439526672, 2.2063957607378284, 1.7671197594042707, 2.824011383665007, 1.606362978935556, 0.6582095206841128, 0.007095149188959068, 1.3930774256702014, 0.06868149956523253, 0.9630197772317862, 0.0039840853722452295, 0.1503437830110423, 0.17956720100506293, 0.5995261548352345, 0.8944518211128312, 0.002690482033281694, 0.17372354005206037, 0.0011379285672351894, 0.6487601398704814, 0.0038427431437744984, 0.04041967216351785, 0.2754425180032469, 0.0004584253080996041, 0.117576853622636, 0.01715570666336551, 0.014830844870604072, 0.24793238344925556, 0.31441757896433636, 0.07304957483994635, 0.429056274655974, 0.14751088031853704, 0.01743055266251278, 0.21235262902583277, 0.20330604558307475, 0.09290561716358525, 0.10081183119362937, 0.25191816552960067, 0.31476765415628144, 0.24156682220765163, 0.1965829976659299, 0.0036627909885841373, 0.004003797886667551, 0.043906724896653884, 0.6576965148772368, 0.00834824622179205, 0.22690078880349274, 0.182579802740797, 0.8664439933451543, 5.609155078916083e-13, 1.8948884100795913e-14, 1.5328768019238796e-13, 1.1292112812837203e-14, 3.0584298128248824e-15, 2.3645773254234105e-13, 1.1457284516035855e-12, 2.6526886236658814e-13, 4.218091021810441e-15]
vsq=np.array(vsq)
loggso=[7.602401335665818, 7.602401335665818, 7.602401335665818, 7.602401335665818, 7.596167611353869, 7.577090735455274, 7.508174228857849, 7.459330862793357, 7.511200240274957, 7.494630540933316, 7.484167866829829, 7.432818680493923, 7.450272123195597, 7.444325380558689, 7.412628092508716, 7.326276248513858, 7.361423070658128, 7.284917815818446, 7.298673260537574, 7.301750000964021, 7.272906245551645, 7.2378175491266274, 7.211488655159624, 7.185783703005231, 7.163354632836176, 7.1069098789360465, 7.097748823631952, 7.08735598015552, 7.050818257735501, 7.023042182471561, 6.9938126779987675, 6.9701464582322386, 6.936878995450158, 6.883931556425757, 6.855721282983416, 6.863696298536866, 6.830006033388024, 6.78215535350162, 6.765161168685511, 6.755755614616298, 6.735755088340949, 6.707309943435187, 6.6943364001929835, 6.641851955896936, 6.6379538459386245, 6.597192873989132, 6.574429467609793, 6.530284828911219, 6.536057956004857, 6.4984024276963, 6.463544668079322, 6.472287737932775, 6.425623571964009, 6.403034378768116, 6.352111464306029, 6.33502724372646, 6.314500540733629, 6.213603577591818, 6.247628707348583, 6.238219973008223, 6.200176194051952, 6.210642409639775, 6.183381741543103, 6.1298886198999165, 6.112367696409599, 6.052369335193921, 6.043918710789948, 6.026345741380855, 5.953573355700728, 5.994748666317796, 5.9651422256460425, 5.87795158514275, 5.8748829341288795, 5.876624924293691, 5.851050739369182, 5.827364877052283, 5.771930790574089, 5.757594942685402, 5.76640488678213, 5.725591597116511, 5.689890246707716, 5.662172964075719, 5.614592041692397, 5.585546485794264, 5.577268935262858, 5.544187398074138, 5.497197741865699, 5.459443410182297, 5.435609238867309, 5.452548395310225, 5.415739087138223, 5.382532122551512, 5.376501233651761, 5.3458336406324, 5.30125432664879, 5.2705891925891235, 5.251410396947259, 5.196382299769537, 5.196628169401083, 5.105501461286599, 5.135374587518218, 5.135887139043417, 5.108300144017141, 5.086953608144281, 5.037620382503287, 5.02180260922901, 4.9530297838607105, 4.979180311275771, 4.925162354447936, 4.905685493779481, 4.8890157196185555, 4.820805184262291, 4.847258026553145, 4.807420028407243, 4.735789117810756, 4.721018076794461, 4.7061632120803045, 4.669104438866534, 4.65756983974673, 4.624840645346454, 4.623314451807609, 4.580847541803833, 4.569008456926987, 4.567435257544361, 4.510126772082419, 4.5188365325425375, 4.421736668941008, 4.433656164804267, 4.382667949293208, 4.3846544213623755, 4.37008875695364, 4.317222658518104, 4.336321460482392, 4.253209440935986, 4.273071642563645, 4.241549210110557, 4.206221744022517, 4.172167671231789, 4.13193971540587, 4.136490930102513, 4.107949273808532, 4.047813735322161, 3.9701090889264985, 4.008791481145639, 3.973529993485007, 3.9586604945823063, 3.901945114259436, 3.8707379657008163, 3.9002647608290215, 3.8180149488576856, 3.836827844110864, 3.7572371336569637, 3.7967007169730422, 3.673503478536361, 3.7174474808997564, 3.7093472960532967, 3.670826314094802, 3.634067753258294, 3.62268308526826, 3.575728115952782, 3.5446088510119234, 3.5369037969987365, 3.487784634771947, 3.5094362520091367, 3.4437775672909647, 3.327532943295674, 3.3982979125026835, 3.390558141147184, 3.3662340274905627, 3.324211832167497, 3.258265562574501, 3.261632811687, 3.2667673683491283, 3.242463990084889, 3.1845133465936812, 3.148783447672501, 3.1793905754597382, 3.1307879947253396, 3.0883334092084773, 3.0618211178823405, 3.0511426932560086, 3.023612132657036, 2.9491109254959267, 2.9761537049585605, 2.917991505217671, 2.8829519736101794, 2.892693536192924, 2.872190928508115, 2.8331915669520367, 2.7406809542086292, 2.7633422804537324, 2.745388623116114, 2.698660446829919, 2.680946137964111, 2.681242524537562, 2.66326274336644, 2.630944739957909, 2.6102641234267714, 2.5203456901576473, 2.5147754721165136, 2.5014808246825586, 2.4779530932532765, 2.4466500061936185, 2.370912244881941, 2.40790669719366, 2.349598341611342, 2.3302502896931543, 2.3264469593976482, 2.2704064187878674, 2.2037054364635225, 2.235494453028213, 2.1574243106342212, 2.177328956258813, 2.1615480274556242, 2.045111439350216, 2.085687052959634, 2.0731882782059197, 2.064648380275706, 2.046293489117524, 1.9998230036455193, 1.9875018509460423, 1.9762450142967491, 1.9189300218071825, 1.8903396099994054, 1.8760190377418118, 1.7328819641712627, 1.7805823748089404, 1.7694137048832876, 1.7596921746051, 1.7543629112668189, 1.7235910810772777, 1.6815726066382726, 1.6688359001828008, 1.607972581384802, 1.5585933973147974, 1.5488378439793933, 1.5688419773561866, 1.5116206213109475, 1.493605245565932, 1.4481183960073818, 1.4637074832501327, 1.384496467254562, 1.4215986059685553, 1.3856044483188297, 1.3479970705498927, 1.2735443200825847, 1.3076948807557571, 1.274205342614566, 1.241017605641846, 1.234562407224997, 1.1893702524258554, 1.1079912739932396, 1.1032545776624392, 1.088669999810719, 1.0845356911510784, 1.0274566596717114, 0.9990112127660811, 0.979683827838554, 0.9566500122656003, 0.8887374125251171, 1.0218312660520448, 1.0360992457596756, 1.0257653451546032, 0.9082040434669167, 0.9300404947200936, 0.9403878054848257, 0.8590615742031008, 0.8600708863399021, 0.8053192873080988, 0.7930071384223139, 0.8225540989730538, 0.7371157926060868, 0.628171427443674, 0.6863815340410343, 0.5552684845829962, 0.5878133219476308, 0.5024897981670855, 0.5507390632853949, 0.43602130002894124,       0.37356882266530494, 0.33791545027521386, 0.28832967146247246, 0.31051187754894427, 0.26042011478015614, 0.16119504941734794, 0.17149150583684056, 0.12288261914545007, 0.008647733096067896, -0.10716829001594996, -0.13309988002872147, -0.05705110829170022, -0.12364938869654747, -     0.07167915429754254, -0.08888679350367533, -0.12334290826231604, -0.08944904108508607, -0.09294900213214996, -0.16515900637233846, -0.17894462753916357, -0.18055781074743468, -0.15283897832669668, -0.10474602443609161]
gsosq=np.exp(np.array(loggso)*2)

chi_beta = RealDistribution('chisquared', beta)
chi_1 = RealDistribution('chisquared', 1)

vsqnorm = np.sum(vsq)

prob_proj = chi_beta.cum_distribution_function(d*gsosq[DSD_kappa]/np.sum(vsq))

# upper bound for success probability babai lifting
# assuming each gso coefficient is i.i.d gaussian distributed
prob_babai_bound = np.exp(np.sum([np.log(chi_1.cum_distribution_function(260*gsosq[i]/4./np.sum(vsq[:260]))) for i in range(260)]))

print("prob_proj = ", prob_proj)
print("prob_babai <=", prob_babai_bound)
print("dense vecs of such length ~", float(N(round(DSD_lf), n)))